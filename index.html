<!DOCTYPE html>
<html>
<head>
	<title>选择存档目录 | Tears of the Kingdom Savegame Editor</title>
	<meta http-equiv="content-Type" content="text/html; charset=UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
	<style type="text/css">
@import url('https://fonts.googleapis.com/css?family=Open+Sans:400,600,700&display=swap');

*{box-sizing:border-box}
body{
	margin:0;
	min-height:100vh;
	display:flex;
	align-items:center;
	justify-content:center;
	background:radial-gradient(circle at 30% 20%, #2f3540, #171b22 65%);
	color:#e8e8e8;
	font-family:'Open Sans', sans-serif;
}
a{color:inherit;text-decoration:none}
.wrapper{
	width:100%;
	max-width:1100px;
	padding:40px 24px 60px;
}
.header{
	text-align:center;
	margin-bottom:26px;
}
.header h1{margin:0 0 10px;font-size:26px;color:#49c5ff;}
.header p{margin:0;color:#b7b7b7;}
.panel{
	background:#20242e;
	border:1px solid #2e3442;
	border-radius:14px;
	padding:28px;
	box-shadow:0 14px 36px rgba(0,0,0,0.45);
}
.picker{
	border:1px dashed #4c5464;
	border-radius:10px;
	padding:30px 20px;
	text-align:center;
	background:#1a1e26;
}
.picker label{
	display:inline-block;
	padding:14px 22px;
	background:#49c5ff;
	color:#0d1a23;
	border-radius:8px;
	font-weight:700;
	cursor:pointer;
	margin-bottom:12px;
	box-shadow:0 8px 22px rgba(73,197,255,0.45);
	transition:transform .12s ease, box-shadow .12s ease;
}
.picker label:hover{transform:translateY(-1px)}
.picker label:active{transform:translateY(0)}
.picker input{display:none}
.status{
	margin-top:10px;
	color:#d5d7dc;
	font-size:14px;
}
.status .muted{color:#8b92a0}
.actions{
	display:flex;
	gap:12px;
	margin-top:18px;
	flex-wrap:wrap;
}
.btn{
	padding:12px 16px;
	border-radius:6px;
	border:1px solid #545a66;
	font-weight:600;
	cursor:pointer;
	background:transparent;
	color:#e8e8e8;
	transition:transform .12s ease, background .12s ease;
}
.btn.primary{
	background:#49c5ff;
	border-color:#49c5ff;
	color:#0d1a23;
	box-shadow:0 6px 20px rgba(73,197,255,0.35);
}
.btn:hover{transform:translateY(-1px);background:#353a45;}
.covers{
	display:grid;
	grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
	gap:16px;
	margin-top:22px;
}
.cover{
	background:#242731;
	border:1px solid #3c414b;
	border-radius:10px;
	overflow:hidden;
	box-shadow:0 6px 18px rgba(0,0,0,0.25);
}
.cover img{
	display:block;
	width:100%;
	height:auto;
}
.cover .label{
	padding:10px 12px;
	font-weight:700;
	color:#dfe3eb;
	border-top:1px solid #3c414b;
	background:linear-gradient(90deg, rgba(73,197,255,0.08), transparent);
}
.cover .meta{
	padding:10px 12px;
	color:#b7b7b7;
	font-size:13px;
	border-top:1px solid #3c414b;
}
.cover .actions{
	display:flex;
	flex-direction:column;
	gap:8px;
	padding:10px 12px 14px;
	border-top:1px solid #3c414b;
}
.btn.block{width:100%;text-align:center;}
.message{
	margin-top:14px;
	color:#b7b7b7;
}
.hint{margin-top:12px;color:#8b92a0;font-size:13px;}
	</style>
</head>
<body>
	<div class="wrapper">
		<div class="header">
			<h1>选择存档目录</h1>
			<p>选择包含《塞尔达传说 王国之泪》存档文件的文件夹。</p>
		</div>
		<div class="panel">
			<div class="picker">
				<label for="dir-input">选择存档目录</label>
				<input type="file" id="dir-input" name="dir-input" webkitdirectory directory multiple />
				<div class="status">
					<div id="status-text" class="muted">尚未选择目录</div>
					<div id="status-detail" class="muted"></div>
				</div>
			</div>
			<div class="message" id="cover-message">尚未加载封面</div>
			<div class="covers" id="cover-list"></div>
			<div class="hint" id="last-root-hint"></div>
		</div>
	</div>
	<script type="text/javascript">
	(function(){
		var input=document.getElementById('dir-input');
		var statusText=document.getElementById('status-text');
		var statusDetail=document.getElementById('status-detail');
		var coverList=document.getElementById('cover-list');
		var coverMessage=document.getElementById('cover-message');
		var lastRootHint=document.getElementById('last-root-hint');
		var currentRoot='';
		var hasNode=typeof window.require==='function';
		var fs=null, path=null, appRoot='';
		if(hasNode){
			try{
				fs=require('fs');
				path=require('path');
				appRoot=__dirname || path.resolve('.');
			}catch(_){
				hasNode=false;
			}
		}
		var userSettings={
			lastSaveRoot:'',
			lastSlots:[],
			lastBackupDir:'',
			lastSaveFileName:'',
			updatedAt:''
		};
		var settingsLocalKey='totkUserSettings';

		loadUserSettings().then(autoLoadLastRoot);

		input.addEventListener('change', function(){
			var files=Array.prototype.slice.call(input.files||[]);
			if(!files.length){
				statusText.textContent='尚未选择目录';
				statusDetail.textContent='';
				coverList.innerHTML='';
				coverMessage.textContent='尚未加载封面';
				return;
			}
			var first=files[0];
			var relativePath=first.webkitRelativePath || first.name;
			var root=relativePath.split('/')[0] || '存档目录';
			currentRoot=root;
			var count=files.length;
			statusText.textContent='已选择目录：'+root;
			var samplePaths=files.slice(0,3).map(function(file){return file.webkitRelativePath || file.name;});
			var extra=files.length>3 ? ' 等' : '';
			statusDetail.textContent='包含 '+count+' 个文件，例如：'+samplePaths.join('，')+extra;

			loadCaptions(files, root);
		});

		async function loadUserSettings(){
			if(hasNode){
				try{
					var diskPath=path.join(appRoot,'user-settings.json');
					if(fs.existsSync(diskPath)){
						var base=JSON.parse(fs.readFileSync(diskPath,'utf8'));
						Object.assign(userSettings, base);
					}
				}catch(_){}
			}else{
				try{
					var res=await fetch('./user-settings.json');
					if(res.ok){
						var base=await res.json();
						Object.assign(userSettings, base);
					}
				}catch(_){}
			}
			try{
				var cached=localStorage.getItem(settingsLocalKey);
				if(cached){
					Object.assign(userSettings, JSON.parse(cached));
				}
			}catch(_){}
			if(userSettings.lastSaveRoot){
				lastRootHint.textContent='上次的目录：'+userSettings.lastSaveRoot;
			}else{
				lastRootHint.textContent='尚未保存过目录';
			}
		}

		function bufferToArrayBuffer(buf){
			return buf.buffer.slice(buf.byteOffset, buf.byteOffset+buf.byteLength);
		}

		async function autoLoadLastRoot(){
			if(!hasNode || !userSettings.lastSaveRoot){
				return;
			}
			var root=userSettings.lastSaveRoot;
			if(!fs.existsSync(root)){
				coverMessage.textContent='上次的目录不存在：'+root;
				return;
			}
			coverMessage.textContent='正在读取 '+root+'...';
			try{
				var files=[];
				var entries=fs.readdirSync(root,{withFileTypes:true});
				entries.forEach(function(entry){
					if(entry.isDirectory() && /^slot/i.test(entry.name)){
						var slotDir=path.join(root, entry.name);
						['caption.sav','progress.sav'].forEach(function(fname){
							var full=path.join(slotDir, fname);
							if(fs.existsSync(full)){
								var buf=fs.readFileSync(full);
								files.push({
									name: fname,
									path: full,
									webkitRelativePath: path.join(entry.name, fname).replace(/\\/g,'/'),
									arrayBuffer: async function(){ return bufferToArrayBuffer(buf); }
								});
							}
						});
					}
				});
				if(files.length){
					currentRoot=path.basename(root);
					statusText.textContent='自动加载目录：'+root;
					statusDetail.textContent='找到 '+files.length+' 个文件';
					loadCaptions(files, root);
				}else{
					coverMessage.textContent='目录中未找到 slot 相关文件：'+root;
				}
			}catch(err){
				coverMessage.textContent='读取目录失败：'+err.message;
			}
		}

		function persistUserSettings(){
			userSettings.updatedAt=new Date().toISOString();
			try{
				localStorage.setItem(settingsLocalKey, JSON.stringify(userSettings));
			}catch(_){}
			writeSettingsFile(); // best-effort
		}

		async function writeSettingsFile(){
			if(hasNode){
				try{
					var diskPath=path.join(appRoot,'user-settings.json');
					fs.writeFileSync(diskPath, JSON.stringify(userSettings, null, 2), 'utf8');
					return true;
				}catch(err){
					console.warn('写入用户设置失败', err);
					return false;
				}
			}
			return false;
		}

		function findSlotName(pathStr){
			var match=pathStr.match(/(^|[\\/])(slot[^\\/]+)([\\/]|$)/i);
			return match ? match[2] : null;
		}

		function captionReadU32ByHash(view, targetHash){
			for(var i=0x000028; i<0x000001c0; i+=8){
				var hash=view.getUint32(i, true);
				if(hash===targetHash){
					return view.getUint32(i+4, true);
				}
			}
			return null;
		}

		function captionReadBoolByHash(view, targetHash){
			for(var i=0x000028; i<0x000001c0; i+=8){
				var hash=view.getUint32(i, true);
				if(hash===targetHash){
					return view.getUint8(i+4) === 1;
				}
			}
			return false;
		}

		function formatDate(dt){
			try{
				return new Intl.DateTimeFormat(undefined, {
					dateStyle:'short',
					timeStyle:'short'
				}).format(dt);
			}catch(_){
				return dt.toISOString();
			}
		}

		function bufferToBase64(buffer){
			var bytes=new Uint8Array(buffer);
			var chunk=0x8000;
			var binary='';
			for(var i=0;i<bytes.length;i+=chunk){
				binary+=String.fromCharCode.apply(null, bytes.subarray(i,i+chunk));
			}
			return btoa(binary);
		}

		async function openSlot(slot, progressFile){
			try{
				var buffer=await progressFile.arrayBuffer();
				var progressPath = (hasNode && progressFile.path) ? progressFile.path : '';
				var saveRoot='';
				if(progressPath && hasNode){
					var slotDir=path.dirname(progressPath);
					saveRoot=path.dirname(slotDir);
					userSettings.lastSaveRoot=saveRoot;
					userSettings.lastSaveFileName=progressPath;
					persistUserSettings();
				}
				var payload={
					slot:slot,
					fileName:progressFile.name,
					progress:bufferToBase64(buffer),
					filePath:progressPath,
					saveRoot:saveRoot
				};
				window.name='TOTK_PAYLOAD:'+JSON.stringify(payload);
				window.location.href='zelda-totk/index.html';
			}catch(err){
				alert('无法打开存档：'+err.message);
			}
		}

		async function parseCaption(file){
			var buffer=await file.arrayBuffer();
			var view=new DataView(buffer);
			var jpgOffset=captionReadU32ByHash(view, 0x63696a32);
			if(jpgOffset===null)
				throw new Error('未找到图片偏移');
			var jpgSize=view.getUint32(jpgOffset, true);
			if(jpgOffset+4+jpgSize>buffer.byteLength)
				throw new Error('图片数据不完整');
			var bytes=new Uint8Array(buffer, jpgOffset+4, jpgSize);
			var blob=new Blob([bytes], {type:'image/jpeg'});
			var imgUrl=URL.createObjectURL(blob);

			var year=captionReadU32ByHash(view, 0x9811A3F7);
			var minute=captionReadU32ByHash(view, 0x27853BF7);
			var hour=captionReadU32ByHash(view, 0x23F3D75E);
			var month=captionReadU32ByHash(view, 0xDFD840D3);
			var day=captionReadU32ByHash(view, 0xBD46F485);
			var isAutosave=captionReadBoolByHash(view, 0x25F03CAA);

			var dateText='未知时间';
			if(year && month && day && hour!=null && minute!=null){
				var dt=new Date(year, month-1, day, hour, minute);
				dateText=formatDate(dt);
			}

			return {
				imgUrl: imgUrl,
				dateText: dateText,
				isAutosave: isAutosave
			};
		}

		async function loadCaptions(files, rootName){
			var existingErrors=document.querySelectorAll('.message.error');
			existingErrors.forEach(function(el){el.remove();});

			coverList.innerHTML='';
			coverMessage.textContent='正在读取封面...';

			var captionMap=new Map();
			var progressMap=new Map();
			files.forEach(function(file){
				var relPath=file.webkitRelativePath || file.name;
				var slot=findSlotName(relPath);
				if(slot){
					if(file.name==='caption.sav'){
						captionMap.set(slot, file);
					}else if(file.name==='progress.sav'){
						progressMap.set(slot, file);
					}
				}
			});

			if(!captionMap.size){
				coverMessage.textContent='未找到包含 slot 的目录（缺少 caption.sav）';
				return;
			}

			if(rootName){
				userSettings.lastSaveRoot=rootName;
			}
			userSettings.lastSlots=Array.from(captionMap.keys());
			persistUserSettings();

			var errors=[];
			for(const [slot, file] of captionMap){
				try{
					var captionData=await parseCaption(file);
					var card=document.createElement('div');
					card.className='cover';

					var img=document.createElement('img');
					img.src=captionData.imgUrl;
					img.alt=slot+' 封面';

					var label=document.createElement('div');
					label.className='label';
					label.textContent=slot;

					var meta=document.createElement('div');
					meta.className='meta';
					meta.textContent=captionData.dateText+(captionData.isAutosave ? ' · 自动存档' : '');

					var actions=document.createElement('div');
					actions.className='actions';
					const progressFile=progressMap.get(slot);
					if(progressFile){
						var openBtn=document.createElement('button');
						openBtn.className='btn block';
						openBtn.textContent='编辑此存档';
						openBtn.addEventListener('click', function(){
							openSlot(slot, progressFile);
						});
						actions.appendChild(openBtn);
					}else{
						var warn=document.createElement('div');
						warn.className='message';
						warn.style.color='#ffb347';
						warn.textContent='缺少 progress.sav 无法打开';
						actions.appendChild(warn);
					}

					card.appendChild(img);
					card.appendChild(label);
					card.appendChild(meta);
					card.appendChild(actions);
					coverList.appendChild(card);
				}catch(err){
					errors.push(slot+': '+err.message);
				}
			}

			if(coverList.childElementCount){
				coverMessage.textContent='找到 '+coverList.childElementCount+' 个存档槽封面';
			}else{
				coverMessage.textContent='未能解析任何封面';
			}

			if(errors.length){
				var errorDiv=document.createElement('div');
				errorDiv.className='message error';
				errorDiv.style.color='#ff9f9f';
				errorDiv.textContent='解析出错：'+errors.join('；');
				coverList.parentNode.insertBefore(errorDiv, coverList);
			}
		}
	})();
	</script>
</body>
</html>
